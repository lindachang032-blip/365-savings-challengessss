<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>365天支付挑戰 - 獨立雲端版</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 核心邏輯：動態識別 App ID ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 解決你的問題：從網址獲取群組名稱，若無則使用預設值
        // 這樣每個人分享原始網址時，因為 Auth UID 不同，資料就會分開
        const urlParams = new URLSearchParams(window.location.search);
        const groupName = urlParams.get('group') || 'personal';
        const appId = typeof __app_id !== 'undefined' ? __app_id : `365-challenge-${groupName}`;

        let state = {
            paidDays: [],
            user: null
        };

        const totalDays = 365;
        const totalGoal = (totalDays / 2) * (2 + (totalDays * 2));

        const challengeGrid = document.getElementById('challenge-grid');
        const modalOverlay = document.getElementById('modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalAmountDisplay = document.getElementById('modal-amount');
        
        let currentSelectingDay = null;
        let isRevoking = false;

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Auth Error:", error);
            }
        };

        onAuthStateChanged(auth, (user) => {
            state.user = user;
            if (user) {
                document.getElementById('user-id-display').innerText = `個人識別碼: ${user.uid.substring(0, 8)}...`;
                
                // 指向獨立的資料路徑：/artifacts/{appId}/users/{userId}/...
                // 這樣每個人的 UID 不同，儲存的位置就絕對不會重疊
                const docRef = doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'progress');
                
                onSnapshot(docRef, (docSnap) => {
                    state.paidDays = docSnap.exists() ? (docSnap.data().days || []) : [];
                    renderGrid();
                    updateStats();
                }, (error) => {
                    console.error("Firestore Error:", error);
                });
            }
        });

        function renderGrid() {
            challengeGrid.innerHTML = '';
            for (let i = 1; i <= totalDays; i++) {
                const isPaid = state.paidDays.includes(i);
                const box = document.createElement('div');
                box.className = 'day-box' + (isPaid ? ' paid' : '');
                box.innerHTML = `
                    <span class="day-num">Day ${i}</span>
                    <span class="amount">$${i * 2}</span>
                `;
                box.onclick = () => isPaid ? openRevokeModal(i) : openPaymentModal(i);
                challengeGrid.appendChild(box);
            }
        }

        function updateStats() {
            const count = state.paidDays.length;
            const currentSum = state.paidDays.reduce((sum, day) => sum + (day * 2), 0);
            const remaining = totalGoal - currentSum;
            const percentage = ((count / totalDays) * 100).toFixed(1);

            document.getElementById('paid-days').innerText = `${count} / ${totalDays}`;
            document.getElementById('paid-amount').innerText = `$${currentSum.toLocaleString()}`;
            document.getElementById('remaining-amount').innerText = `$${remaining.toLocaleString()}`;
            document.getElementById('percent-text').innerText = `${percentage}%`;
            document.getElementById('progress-fill').style.width = `${percentage}%`;
        }

        window.openPaymentModal = (day) => {
            currentSelectingDay = day;
            isRevoking = false;
            modalTitle.innerText = `Day ${day} 支付確認`;
            modalAmountDisplay.innerText = `$${day * 2}`;
            modalAmountDisplay.style.color = "var(--primary-color)";
            document.getElementById('btn-confirm-text').innerText = "確定付款";
            modalOverlay.style.display = 'flex';
        };

        window.openRevokeModal = (day) => {
            currentSelectingDay = day;
            isRevoking = true;
            modalTitle.innerText = `取消 Day ${day} 支付?`;
            modalAmountDisplay.innerText = `$${day * 2}`;
            modalAmountDisplay.style.color = "#e57373";
            document.getElementById('btn-confirm-text').innerText = "確定取消";
            modalOverlay.style.display = 'flex';
        };

        window.closeModal = () => { modalOverlay.style.display = 'none'; };

        window.confirmAction = async () => {
            if (!state.user || !currentSelectingDay) return;
            let newList = isRevoking ? state.paidDays.filter(d => d !== currentSelectingDay) : [...state.paidDays, currentSelectingDay];
            const docRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'settings', 'progress');
            try {
                await setDoc(docRef, { days: [...new Set(newList)] });
                closeModal();
            } catch (e) { console.error("Save error", e); }
        };

        initAuth();
        window.addEventListener('DOMContentLoaded', () => { if (window.lucide) lucide.createIcons(); });
    </script>

    <style>
        :root {
            --bg-color: #f5f2ed; --card-bg: #fffcf9; --primary-color: #d4a373; 
            --secondary-color: #7a918d; --accent-color: #e9edc9; --text-main: #4a4238; 
            --text-muted: #8b8071; --border-color: #e6dfd1; --shadow: 0 10px 15px -3px rgba(74, 66, 56, 0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Quicksand', sans-serif; }
        body { background-color: var(--bg-color); color: var(--text-main); padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { max-width: 1100px; width: 100%; }
        header { text-align: center; margin-bottom: 30px; }
        header h1 { font-size: 2.2rem; display: flex; align-items: center; justify-content: center; gap: 12px; margin-bottom: 8px;}
        .user-badge { font-size: 0.7rem; background: #eeeae4; padding: 4px 12px; border-radius: 20px; color: var(--text-muted); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--card-bg); padding: 20px; border-radius: 20px; box-shadow: var(--shadow); text-align: center; border: 1px solid var(--border-color); }
        .stat-card .value { font-size: 1.6rem; font-weight: 700; color: var(--text-main); }
        .stat-card .label { font-size: 0.85rem; color: var(--text-muted); font-weight: 600; margin-bottom: 5px; display: block;}
        .progress-container { background: var(--card-bg); padding: 20px; border-radius: 25px; margin-bottom: 30px; border: 1px solid var(--border-color); }
        .progress-bar-bg { background: var(--border-color); height: 12px; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-bar-fill { background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); height: 100%; width: 0%; border-radius: 10px; transition: width 0.8s ease; }
        .challenge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 12px; background: var(--card-bg); padding: 20px; border-radius: 25px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .day-box { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; background-color: #fdfaf7; border-radius: 15px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .day-box .day-num { font-size: 0.7rem; color: var(--text-muted); }
        .day-box .amount { font-size: 1rem; font-weight: 700; }
        .day-box:hover { transform: translateY(-2px); border-color: var(--primary-color); }
        .day-box.paid { background-color: var(--secondary-color); color: white; }
        .day-box.paid .day-num { color: rgba(255,255,255,0.8); }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 30px; width: 90%; max-width: 350px; text-align: center; box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .modal-amount { font-size: 3rem; font-weight: 700; margin: 15px 0; }
        .btn-group { display: flex; gap: 10px; margin-top: 20px; }
        button { flex: 1; padding: 12px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; transition: opacity 0.2s; }
        .btn-confirm { background: var(--primary-color); color: white; }
        .btn-cancel { background: #eeeae4; color: var(--text-muted); }
        @media (max-width: 500px) { .challenge-grid { grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; padding: 12px; } }
    </style>
</head>
<body>
<div class="container">
    <header>
        <h1><i data-lucide="piggy-bank"></i> 365天儲蓄挑戰</h1>
        <p>每一份累積，都是對未來最好的投資</p>
        <div id="user-id-display" class="user-badge">正在識別身份...</div>
    </header>
    <div class="progress-container">
        <div style="display: flex; justify-content: space-between;"><span style="font-weight: 700; font-size: 0.9rem;">我的挑戰進度</span><span id="percent-text" style="font-weight: 700; color: var(--primary-color);">0%</span></div>
        <div class="progress-bar-bg"><div id="progress-fill" class="progress-bar-fill"></div></div>
    </div>
    <div class="stats-grid">
        <div class="stat-card"><span class="label">已付清天數</span><div id="paid-days" class="value">0 / 365</div></div>
        <div class="stat-card"><span class="label">累積存款</span><div id="paid-amount" class="value">$0</div></div>
        <div class="stat-card"><span class="label">剩餘目標</span><div id="remaining-amount" class="value">$133,590</div></div>
    </div>
    <div id="challenge-grid" class="challenge-grid"></div>
</div>
<div id="modal-overlay" class="modal-overlay">
    <div class="modal">
        <h2 id="modal-title">支付確認</h2>
        <div id="modal-amount" class="modal-amount">$0</div>
        <div class="btn-group">
            <button class="btn-cancel" onclick="closeModal()">取消</button>
            <button class="btn-confirm" onclick="confirmAction()" id="btn-confirm-text">確定</button>
        </div>
    </div>
</div>
</body>
</html>